# DocFlow-AI Backend Services

Este documento descreve as rotas e servi√ßos do backend integrados com Supabase.

## üèóÔ∏è Arquitetura dos Services

O sistema est√° organizado em **6 services principais**:

### 1. **ClientService** - Gerenciamento de Clientes
```typescript
import { ClientService } from "@/services/clientService";

// Buscar todos os clientes
const clients = await ClientService.getClients();

// Criar novo cliente
const newClient = await ClientService.createClient({
  name: "Jo√£o Silva",
  email: "joao@email.com",
  phone: "(11) 99999-9999"
});

// Buscar por ID
const client = await ClientService.getClientById("client-id");

// Atualizar cliente
const updated = await ClientService.updateClient("client-id", {
  name: "Jo√£o da Silva"
});

// Deletar cliente
await ClientService.deleteClient("client-id");

// Buscar clientes (search)
const results = await ClientService.searchClients("Jo√£o");
```

### 2. **CaseService** - Gerenciamento de Casos
```typescript
import { CaseService } from "@/services/caseService";

// Buscar casos (todos ou de um cliente)
const cases = await CaseService.getCases("client-id");

// Criar novo caso
const newCase = await CaseService.createCase({
  name: "Processo Trabalhista",
  clientId: "client-id",
  reference: "5005719-85.2024.4.03.6109",
  description: "A√ß√£o trabalhista por rescis√£o indireta",
  status: "active"
});

// Atualizar caso
const updated = await CaseService.updateCase("case-id", {
  status: "closed"
});
```

### 3. **FolderService** - Gerenciamento de Pastas
```typescript
import { FolderService } from "@/services/folderService";

// Buscar pastas (raiz ou subpastas)
const folders = await FolderService.getFolders(); // Pastas raiz
const subfolders = await FolderService.getFolders("parent-id");

// Criar nova pasta
const newFolder = await FolderService.createFolder({
  name: "Contratos",
  kind: "subfolder",
  parentId: "client-folder-id",
  clientId: "client-id",
  path: "Jo√£o Silva/Contratos"
});

// Buscar pastas
const results = await FolderService.searchFolders("Jo√£o Silva");
```

### 4. **DocumentService** - Upload e Gerenciamento de Documentos
```typescript
import { DocumentService } from "@/services/documentService";

// Upload de arquivo
const storagePath = await DocumentService.uploadFile(
  file, 
  "clients/client-id/folder", 
  (progress) => console.log(`${progress}%`)
);

// Criar documento no banco
const document = await DocumentService.createDocument({
  name: "contrato.pdf",
  mimeType: "application/pdf",
  size: 1024000,
  clientId: "client-id",
  caseId: "case-id",
  folderId: "folder-id",
  type: "pdf",
  docNumber: "DOC n. 001",
  supabaseStoragePath: storagePath
});

// Buscar documentos
const docs = await DocumentService.getDocuments({
  clientId: "client-id",
  caseId: "case-id"
});

// Gerar URL de download
const downloadUrl = await DocumentService.getDownloadUrl("doc-id");

// Gerar pr√≥ximo n√∫mero
const nextNumber = await DocumentService.getNextDocNumber("client-id");
```

### 5. **PetitionService** - Gera√ß√£o de Fatos
```typescript
import { PetitionService } from "@/services/petitionService";

// Criar Fatos
const petition = await PetitionService.createPetition({
  title: "Fatos Inicial - Processo Trabalhista",
  clientId: "client-id",
  caseId: "case-id",
  content: "# Fatos INICIAL...",
  documentIds: ["doc1", "doc2"],
  template: "template-id",
  status: "draft"
});

// Adicionar fato √† Fatos
const fact = await PetitionService.addFactToPetition("petition-id", {
  type: "contratual",
  text: "O contrato foi assinado em 15/01/2024...",
  documentRefs: ["doc-id"],
  confidence: 0.95
});

// Exportar Fatos
const blob = await PetitionService.exportPetition("petition-id", "pdf");
```

### 6. **SettingsService** - Configura√ß√µes do Usu√°rio
```typescript
import { SettingsService } from "@/services/settingsService";

// Buscar configura√ß√µes
const settings = await SettingsService.getUserSettings();

// Atualizar configura√ß√µes
const updated = await SettingsService.updateUserSettings({
  naming: {
    pattern: "DOC n. {seq} - {client} - {date}",
    uppercaseClient: true,
    useUnderscores: false,
    seqResetPerClient: true,
    dateFormat: "dd/MM/yyyy"
  },
  petition: {
    template: "# Fatos INICIAL\n\n{content}",
    factCategories: ["contratual", "processual", "probat√≥rio"],
    autoExtractFacts: true
  }
});

// Resetar para padr√£o
const defaults = await SettingsService.resetToDefaults();
```

## üé£ Hooks React Query

Para facilitar o uso no frontend, criamos hooks customizados:

### Hooks de Clientes
```typescript
import { useClients, useCreateClient, useUpdateClient } from "@/hooks/useClients";

function ClientList() {
  const { data: clients, isLoading } = useClients();
  const createMutation = useCreateClient();
  
  const handleCreate = () => {
    createMutation.mutate({
      name: "Novo Cliente",
      email: "cliente@email.com"
    });
  };
  
  return (
    <div>
      {isLoading ? "Carregando..." : clients?.map(client => (
        <div key={client.id}>{client.name}</div>
      ))}
      <button onClick={handleCreate}>Criar Cliente</button>
    </div>
  );
}
```

### Hooks de Upload Inteligente
```typescript
import { useSmartUpload } from "@/hooks/useSmartUpload";

function UploadPage() {
  const {
    uploadFiles,
    addFiles,
    processUploads,
    isUploading,
    completedCount
  } = useSmartUpload();
  
  const handleDrop = (files: File[]) => {
    addFiles(files, {
      type: "existing_folder",
      folderId: "selected-folder-id"
    });
  };
  
  return (
    <div>
      <DropZone onDrop={handleDrop} />
      <button 
        onClick={processUploads} 
        disabled={isUploading}
      >
        {isUploading ? "Enviando..." : "Enviar Arquivos"}
      </button>
      <p>{completedCount} arquivos enviados</p>
    </div>
  );
}
```

## üîó Integra√ß√£o com Supabase

### Storage de Arquivos
- **Bucket**: `documents`
- **Estrutura**: `clients/{clientId}/{folderName}/{filename}`
- **Pol√≠ticas RLS**: Apenas o usu√°rio propriet√°rio pode acessar seus arquivos

### Tabelas Principais
- **clients**: Informa√ß√µes dos clientes
- **cases**: Casos jur√≠dicos
- **folders**: Estrutura hier√°rquica de pastas
- **documents**: Metadados dos documentos
- **petitions**: Fatos geradas
- **facts**: Fatos extra√≠dos dos documentos
- **user_settings**: Configura√ß√µes personalizadas

### Autentica√ß√£o
```typescript
import { supabase } from "@/integrations/supabase/client";

// Verificar usu√°rio logado
const { data: user } = await supabase.auth.getUser();

// Todos os services verificam automaticamente a autentica√ß√£o
// e filtram dados pelo user_id
```

## üöÄ Como Usar

### 1. **Upload Simples**
```typescript
// Upload direto para pasta existente
const { mutate: upload } = useUploadDocument();

upload({
  file: selectedFile,
  folderPath: "clients/client-id/contratos",
  documentData: {
    name: selectedFile.name,
    mimeType: selectedFile.type,
    size: selectedFile.size,
    clientId: "client-id",
    caseId: "case-id",
    type: detectFileType(selectedFile.name)
  }
});
```

### 2. **Upload com Cria√ß√£o Autom√°tica**
```typescript
// Upload com cria√ß√£o autom√°tica de estruturas
const { processUploads, addFiles } = useSmartUpload();

// Adicionar arquivos para novo cliente
addFiles(files, {
  type: "new_client",
  clientName: "Maria Santos"
});

// Processar uploads (cria cliente, pasta e caso automaticamente)
await processUploads();
```

### 3. **Busca Avan√ßada**
```typescript
// Buscar documentos com filtros
const { data: documents } = useDocuments({
  clientId: "client-id",
  caseId: "case-id",
  type: "pdf"
});

// Buscar com texto
const { data: results } = useSearchDocuments("contrato", {
  clientId: "client-id"
});
```

## üõ°Ô∏è Seguran√ßa

- **Row Level Security (RLS)** ativado em todas as tabelas
- **Filtros autom√°ticos** por `user_id` em todos os services
- **Valida√ß√£o de autentica√ß√£o** em cada opera√ß√£o
- **URLs tempor√°rias** para download de arquivos
- **Soft delete** para documentos (marcados como `deleted`)

## ‚ö° Performance

- **Cache inteligente** com React Query
- **Invalida√ß√£o autom√°tica** de cache ap√≥s muta√ß√µes
- **Stale time** otimizado por tipo de dados
- **Parallel uploads** para m√∫ltiplos arquivos
- **Progress tracking** em tempo real

Este sistema de backend est√° completamente integrado com o frontend React e pronto para uso em produ√ß√£o! üéâ

---

## ü§ñ Configura√ß√µes de IA

### Modelo Atual: GPT-5

O sistema utiliza o modelo `gpt-5` da OpenAI para gera√ß√£o de fatos e renomea√ß√£o inteligente de documentos.

#### Rate Limits (Tier 2)
- **TPM (Tokens por Minuto):** 500,000
- **RPM (Requests por Minuto):** 500
- **TPD (Tokens por Dia):** 1,500,000

#### Par√¢metros Suportados
O GPT-5 **n√£o suporta** os par√¢metros tradicionais de customiza√ß√£o:
- ‚ùå `temperature`
- ‚ùå `top_p`
- ‚ùå `frequency_penalty`
- ‚ùå `presence_penalty`

**Par√¢metro √∫nico suportado:**
- ‚úÖ `max_completion_tokens` (substitui o antigo `max_tokens`)

### Rate Limiter (`src/lib/rateLimiter.ts`)

Configura√ß√µes de controle de taxa para evitar exceder limites da API:

```typescript
const TPM_BUDGET = 490000;  // 490k tokens/min (margem de 10k)
const RPM_BUDGET = 490;      // 490 requests/min (margem de 10)
```

**Funcionalidades:**
- Sistema de lock/sem√°foro para sincroniza√ß√£o de requests
- Reserva de tokens antes de cada chamada
- Libera√ß√£o autom√°tica de tokens em caso de erro
- Janela deslizante de 60 segundos
- Logs detalhados de utiliza√ß√£o

### Facts AI Service (`src/services/factsAIService.ts`)

Servi√ßo respons√°vel por gerar s√≠nteses e procura√ß√µes usando IA.

#### Configura√ß√µes Cr√≠ticas

```typescript
TIMEOUT: 300000              // 5 minutos (300s)
MAX_TOKENS_PER_REQUEST: 100000   // 100k tokens por chunk
MAX_OUTPUT_TOKENS: 16000         // 16k tokens para resposta
```

#### Por que esses valores?

**1. TIMEOUT = 5 minutos**
- GPT-5 usa "reasoning tokens" (racioc√≠nio interno) que aumentam tempo de processamento
- Requests grandes (~200k tokens) precisam de mais tempo
- Timeout anterior de 2 minutos causava abortos prematuros

**2. MAX_TOKENS_PER_REQUEST = 100k tokens**
- Aproveita melhor o contexto grande do GPT-5
- Reduz n√∫mero de chunks (menos divis√µes = mais r√°pido)
- Anterior era 25k, causava fragmenta√ß√£o excessiva

**3. MAX_OUTPUT_TOKENS = 16k tokens**
- GPT-5 usa **reasoning tokens** (~1k) que consomem do `max_completion_tokens` mas **n√£o aparecem no `content`**
- Espa√ßo necess√°rio: reasoning (~1k) + resposta real (~15k)
- Valor anterior de 1k resultava em respostas vazias (`content: ""`)

#### Estrutura da Resposta GPT-5

```json
{
  "choices": [{
    "message": {
      "content": "Resposta vis√≠vel ao usu√°rio",
      "role": "assistant"
    },
    "finish_reason": "length" | "stop"
  }],
  "usage": {
    "completion_tokens": 16000,
    "completion_tokens_details": {
      "reasoning_tokens": 1000,    // ‚Üê Racioc√≠nio interno (invis√≠vel)
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
```

**‚ö†Ô∏è IMPORTANTE:** Os `reasoning_tokens` s√£o contabilizados no `completion_tokens` total mas **n√£o aparecem** no campo `content`. Por isso √© cr√≠tico deixar margem generosa no `max_completion_tokens`.

### AI Renaming Service (`src/services/aiRenamingService.ts`)

Servi√ßo para renomea√ß√£o inteligente de documentos.

```typescript
MODEL: 'gpt-5'
TIMEOUT: 30000               // 30 segundos
max_completion_tokens: 100   // Nomes curtos, precisa menos tokens
```

### Padr√µes de Logs

Todos os logs do sistema **n√£o utilizam emojis** para facilitar parsing e an√°lise autom√°tica.

**Exemplo:**
```typescript
// ‚ùå Evitar
console.log('ü§ñ Iniciando processamento...');

// ‚úÖ Usar
console.log('Iniciando processamento...');
```

### Troubleshooting Comum

#### 1. "Content vazio" / "No response from OpenAI"
**Causa:** `max_completion_tokens` muito baixo
**Solu√ß√£o:** Aumentar para pelo menos 16k para dar espa√ßo aos reasoning tokens

#### 2. "Timeout in facts generation"
**Causa:** Timeout muito curto para requests grandes
**Solu√ß√£o:** Aumentar `TIMEOUT` para 300000ms (5 minutos)

#### 3. "Unsupported parameter: 'temperature'"
**Causa:** GPT-5 n√£o aceita par√¢metros de customiza√ß√£o
**Solu√ß√£o:** Remover todos os par√¢metros exceto `max_completion_tokens`

#### 4. "Or√ßamento de tokens insuficientes"
**Causa:** Race condition no rate limiter ou budget muito baixo
**Solu√ß√£o:** Sistema j√° implementa lock/sem√°foro com 490k TPM budget